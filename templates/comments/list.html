<div class="ui comments" style="padding-top: 1em;">
    <h3 class="ui header">
        <i class="talk outline icon"></i>
        {{ _('Comments') }}
    </h3>
    {% if has_comments %}
<<<<<<< HEAD
        {% set logged_in = request.user.is_authenticated %}
        {% set profile = request.user.profile if logged_in else None %}
        {% for node in mptt_tree(comment_list) recursive %}
            {% if not node.hidden or perms.judge.change_comment %}
                <div class="comment" id="comment-{{ node.id }}" style="position: inherit">
                    {% with author=node.author, user=node.author.user %}
                        <a href="{{ url('user_page', user.username) }}" class="avatar">
                            <img src="{{ gravatar(author, 135) }}">
                        </a>
                    {% endwith %}
                    <div class="content">
                        <span class="author">
                            {{ link_user(node.author) }}
                        </span>
                        <div class="metadata">
                            <span class="date">
                                {{ relative_time(node.time, abs=_('commented on {time}'), rel=_('commented {time}')) }}
=======
        <ul class="comments top-level-comments new-comments">
            {% set logged_in = request.user.is_authenticated %}
            {% set profile = request.user.profile if logged_in else None %}
            {% for node in mptt_tree(comment_list) recursive %}{% if not node.hidden %}
                <li id="comment-{{ node.id }}" data-revision="{{ node.revisions - 1 }}"
                    data-max-revision="{{ node.revisions - 1 }}"
                    data-revision-ajax="{{ url('comment_revision_ajax', node.id) }}" class="comment">
                    <div class="comment-display{% if node.score <= vote_hide_threshold %} bad-comment{% endif %}">
                        <div class="info">
                            <div class="vote">
                                {% if logged_in %}
                                    <a href="javascript:comment_upvote({{ node.id }})"
                                       class="upvote-link fa fa-chevron-up fa-fw{% if node.vote_score == 1 %} voted{% endif %}"></a>
                                {% else %}
                                    <a href="javascript:alert('{{ _('Please login to vote')|escapejs }}')" title="{{ _('Please login to vote') }}"
                                       class="upvote-link fa fa-chevron-up fa-fw"></a>
                                {% endif %}
                                <br>
                                <div class="comment-score">{{ node.score }}</div>
                                {% if logged_in %}
                                    <a href="javascript:comment_downvote({{ node.id }})"
                                       class="downvote-link fa fa-chevron-down fa-fw{% if node.vote_score == -1 %} voted{% endif %}"></a>
                                {% else %}
                                    <a href="javascript:alert('{{ _('Please login to vote')|escapejs }}')" title="{{ _('Please login to vote') }}"
                                       class="downvote-link fa fa-chevron-down fa-fw"></a>
                                {% endif %}
                            </div>
                            {% with author=node.author, user=node.author.user %}
                                <a href="{{ url('user_page', user.username) }}" class="user">
                                    <img src="{{ gravatar(author, 135) }}" class="gravatar">
                                </a>
                            {% endwith %}
                        </div>
                        <div class="detail">
                            <div class="header">
                                {{ link_user(node.author) }}&nbsp;
                                {{ relative_time(node.time, abs=_('commented on {time}'), rel=_('commented {time}')) }}
                                <span class="comment-spacer"></span>
                                <span class="comment-operation">
                                {% if node.revisions > 1 %}
                                    <span class="comment-edits">
                                        <a href="javascript:show_revision({{ node.id }}, -1)"
                                           class="previous-revision">&larr;</a>
                                        <span class="comment-edit-text">
                                            {% if node.revisions > 2 %}
                                                {% trans edits=node.revisions - 1 %}edit {{ edits }}{% endtrans %}
                                            {% else %}
                                                {{ _('edited') }}
                                            {% endif %}
                                        </span>
                                        <a href="javascript:show_revision({{ node.id }}, 1)" style="visibility: hidden"
                                           class="next-revision">&rarr;</a>
                                    </span>
                                {% else %}
                                    <span class="comment-edits"></span>
                                {% endif %}
                                    <a href="#comment-{{ node.id }}" title="{{ _('Link') }}" class="comment-link">
                                    <i class="fa fa-link fa-fw"></i>
                                </a>
                                    {% if logged_in and not comment_lock %}
                                        {% set can_edit = node.author.id == profile.id and not profile.mute %}
                                        {% if can_edit %}
                                            <a data-featherlight="{{ url('comment_edit_ajax', node.id) }}"
                                               href="{{ url('comment_edit', node.id) }}"
                                               title="{{ _('Edit') }}" class="edit-link">
                                            <i class="fa fa-pencil fa-fw"></i>
                                        </a>
                                        {% else %}
                                            <a href="javascript:comment_set_parent({{ node.id }})"
                                               title="{{ _('Reply') }}">
                                            <i class="fa fa-reply fa-fw"></i>
                                        </a>
                                        {% endif %}
                                        {% if perms.judge.change_comment %}
                                            {% if can_edit %}
                                                <a href="javascript:comment_set_parent({{ node.id }})"
                                                   title="{{ _('Reply') }}"><i class="fa fa-reply fa-fw"></i></a>
                                            {% else %}
                                                <a data-featherlight="{{ url('comment_edit_ajax', node.id) }}"
                                                   href="{{ url('comment_edit', node.id) }}" title="{{ _('Edit') }}"
                                                   class="edit-link"><i class="fa fa-pencil fa-fw"></i></a>
                                            {% endif %}
                                            <a href="javascript:" title="{{ _('Hide') }}" data-id="{{ node.id }}"
                                               class="hide-comment"><i class="fa fa-trash fa-fw"></i></a>
                                            <a href="{{ url('admin:judge_comment_change', node.id) }}"
                                               title="{{ _('Admin') }}"><i class="fa fa-cog fa-fw"></i></a>
                                        {% endif %}
                                    {% endif %}
>>>>>>> 0111ee1fe7d5066bebd6e822b4ee0cee123bc8a8
                            </span>
                            {% if node.hidden %}
                            <span class="public">
                                <b>(hidden)</b>
                            </span>
                            {% endif %}
                        </div>
                        {% if node.score < -10 %}
                            <div id="comment-cover-{{ node.id }}" class="text" style="background-color: rgba(0,0,0,.2)">
                                <p>The comment is hidden because of too negative feedback, click <a href="javascript:show_comment({{ node.id }})">here</a> to view it.</p>
                            </div>
                            <div id="comment-hidden-{{ node.id }}" class="text" style="display: none">
                                {{ node.body|safe }}
                            </div>
<<<<<<< HEAD
                        {% else %}
                            <div class="text">
                            {% autoescape true %}
                                {{ node.body|safe }}
                            {% endautoescape %}
=======
                            <div class="content content-description">
                                <div class="comment-body"{% if node.score <= vote_hide_threshold %} style="display:none"{% endif %}>
                                    {{ node.body|markdown('comment', MATH_ENGINE, True)|reference|str|safe }}
                                </div>
                                {% if node.score <= vote_hide_threshold %}
                                    <div class="comment-body bad-comment-body">
                                        <p>
                                            {% trans id=node.id %}
                                                This comment is hidden due to too much negative feedback.
                                                Click <a href="javascript:comment_show_content({{ id }})">here</a> to view it.
                                            {% endtrans %}
                                        </p>
                                    </div>
                                {% endif %}
>>>>>>> 0111ee1fe7d5066bebd6e822b4ee0cee123bc8a8
                            </div>
                        {% endif %}
                        <div class="actions">
                            {% if logged_in %}
                                <a href="javascript:comment_upvote({{ node.id }})" class="upvote-link{% if node.vote_score == 1 %} voted{% endif %}" style="margin-right: 0">
                                   <i class="fa fa-thumbs-up fa-fw"></i>&nbsp;
                                </a>
                            {% else %}
                                <a href="javascript:alert('{{ _('Please login to vote')|escapejs }}')" title="{{ _('Please login to vote') }}" class="upvote-link{% if node.vote_score == 1 %} voted{% endif %}" style="margin-right: 0">
                                   <i class="fa fa-thumbs-up fa-fw"></i>&nbsp;
                                </a>
                            {% endif %}
                            <span class="comment-score">{{ node.score }}</span>
                            {% if logged_in %}
                                <a href="javascript:comment_downvote({{ node.id }})" class="downvote-link{% if node.vote_score == -1 %} voted{% endif %}" style="margin-left: 2px">
                                   <i class="fa fa-thumbs-down fa-flip-horizontal fa-fw"></i>&nbsp;
                                </a>
                            {% else %}
                                <a href="javascript:alert('{{ _('Please login to vote')|escapejs }}')" title="{{ _('Please login to vote') }}" class="downvote-link{% if node.vote_score == -1 %} voted{% endif %}" style="margin-left: 2px">
                                   <i class="fa fa-thumbs-down fa-flip-horizontal fa-fw"></i>&nbsp;
                                </a>
                            {% endif %}
                            &nbsp;
                            <a href="javascript:comment_set_parent({{ node.id }})" title="{{ _('Reply') }}" class="reply"><i class="fa fa-reply"></i></a>

                            {% if perms.judge.change_comment %}
                                <a href="javascript:" title="{{ _('Hide') }}" data-id="{{ node.id }}"
                                   class="hide-comment"><i class="fa fa-trash fa-fw"></i></a>
                                <a href="{{ url('admin:judge_comment_change', node.id) }}"
                                   title="{{ _('Admin') }}"><i class="fa fa-cog fa-fw"></i></a>
                            {% endif %}
                        </div>
                    </div>
<<<<<<< HEAD

                    {% with children=node.get_children() %}
                        {% if children %}
                            <div class="comments" style="padding-bottom: 0; margin-left: 2.5em;">{{ loop(children) }}</div>
                        {% endif %}
                    {% endwith %}
                </div>
            {% endif %}
        {% endfor %}
    {% else %}
=======
                </li>
                {% with children=node.get_children() %}
                    {% if children %}
                        <ul class="comments">{{ loop(children) }}</ul>{% endif %}
                {% endwith %}
            {% endif %}{% endfor %}
        </ul>
    {% elif not comment_lock %}
>>>>>>> 0111ee1fe7d5066bebd6e822b4ee0cee123bc8a8
        <p class="no-comments-message">{{ _('There are no comments at the moment.') }}</p>
    {% endif %}
</div>

<div class="ui vertical segment">
{% if request.user.is_authenticated and comment_form and not comment_lock %}
    {% if is_new_user %}
        <div class="ui info message">
            <i class="close icon"></i>
            <p>{{ _('You need to have solved at least one problem before your voice can be heard.') }}</p>
        </div>
    {% else %}

    <form id="comment-submit" class="ui reply form" method="POST">
        {% csrf_token %}
        {{ comment_form.parent }}

        {% if comment_form.errors %}
            <div class="ui error message">
                <i class="close icon"></i>
                {{ comment_form.non_field_errors() }}
                {{ comment_form.parent.errors }}
                {% if comment_form.body.errors %}
                    {{ _('Invalid comment body.') }}
                {% endif %}
            </div>
        {% endif %}

        <div class="field">
            {{ comment_form.body }}
        </div>
        <button type="submit" class="ui primary submit labeled icon button">
            <i class="icon edit"></i> {{ _('Post!') }}
        </button>
    </form>
{% endif %}

{% if comment_lock %}
    <div class="alert alert-warning comment-lock">
        {{ _('Comments are disabled on this page.') }}
    </div>
{% endif %}
</div>
